{"metadata": {"language_info": {"name": "R", "version": "3.4.1", "mimetype": "text/x-r-source", "pygments_lexer": "r", "file_extension": ".r", "codemirror_mode": "r"}, "kernelspec": {"name": "ir", "display_name": "R", "language": "R"}}, "cells": [{"cell_type": "code", "metadata": {"_uuid": "49502979244538eba6eef3bb179986c79167aa97", "_kg_hide-output": true, "_cell_guid": "e273b3ef-f913-4325-a22c-79c95fa747ad", "_kg_hide-input": true}, "source": ["### Setup\n", "library(readr)\n", "library(data.table)\n", "library(reshape)\n", "library(ggplot2)\n", "library(gridExtra)\n", "system(\"ls ../input\")\n", "options(repr.plot.width = 6, repr.plot.height = 3)\n", "df <- read_csv(\"../input/train.csv\")\n", "class(df) <- \"data.frame\"\n", "### Plotting functions\n", "plot_one_way <- function(df,lines, bars = NULL, factor){\n", "  ## If bars not given, do count\n", "  if (is.null(bars)){\n", "    bars <- \"Count\"\n", "    df$Count <- 1\n", "  }\n", "  \n", "  ## Check df contains lines, bars, factor\n", "  if (prod(c(lines,bars,factor)%in%names(df))==0){\n", "    stop(\"lines, bars and factor not all present in df\")\n", "  }\n", "  \n", "  if (!is.factor(df[,factor])){\n", "    df[,factor] <- as.factor(df[,factor])\n", "  }\n", "  \n", "  ## Weight lines by bars for weighted average\n", "  df[,lines] <- df[,lines] * df[,bars]\n", "  \n", "  ## Crunch lines (1 row per factor level and line)\n", "  df.melt <- melt(df [,c(factor,lines)],id=factor)\n", "  df.crunch <- as.data.frame(data.table(df.melt)[,.(value=sum(value))\n", "                                                 ,by = c(factor,\"variable\")])\n", "  \n", "  ## Crunch weight (1 row per factor level)\n", "  df$wt <- df[,bars]\n", "  df.crunch.wt <- as.data.frame(data.table(df)[,.(wt=sum(wt))\n", "                                               ,by = c(factor)])\n", "  \n", "  ## Join weight to line data\n", "  df.crunch$wt <- df.crunch.wt[match(df.crunch[,factor],df.crunch.wt[,factor]),\"wt\"]\n", "  \n", "  ## Average response\n", "  line.avg <- sum(df.crunch$value)/sum(df.crunch$wt)\n", "  \n", "  ## Convert value to average\n", "  df.crunch$value <- df.crunch$value/df.crunch$wt\n", "  \n", "  ## Rescale weight so that max == line.avg\n", "  df.crunch.wt$wt_rescaled <- df.crunch.wt$wt * line.avg / max(df.crunch.wt$wt)\n", "  \n", "     ## Plot a chart\n", "  plot.one_way<-ggplot(df.crunch.wt, aes_string(x=factor,y=\"wt_rescaled\",group=1))+\n", "    geom_bar(stat=\"identity\",fill=\"yellow\",colour=\"white\",alpha=0.3)+\n", "    geom_line(data=df.crunch,aes_string(x=factor,y=\"value\",colour=\"variable\",group=\"variable\"))+\n", "    geom_point(data=df.crunch,aes_string(x=factor,y=\"value\",colour=\"variable\",group=\"variable\"))+\n", "    theme(axis.text.x = element_text(angle = 60, hjust = 1))+\n", "    labs(y = \"value\" )+ggtitle(factor)\n", "  \n", "  return(plot.one_way)\n", "}\n", "\n", "plot_two_way <- function(df,line, bars = NULL, factor1, factor2, rescale = F){\n", "  ## If bars not given, do count\n", "  if (is.null(bars)){\n", "    bars <- \"Count\"\n", "    df$Count <- 1\n", "  }\n", "  \n", "  ## Check df contains lines, bars, factor\n", "  if (prod(c(line,bars,factor1,factor2)%in%names(df))==0){\n", "    stop(\"lines, bars and factor not all present in df\")\n", "  }\n", "  \n", "  if (!is.factor(df[,factor1])){\n", "    df[,factor1] <- as.factor(df[,factor1])\n", "  }\n", "  \n", "  if (!is.factor(df[,factor2])){\n", "    df[,factor2] <- as.factor(df[,factor2])\n", "  }\n", "  \n", "  ## Weight lines by bars for weighted average\n", "  df[,line] <- df[,line] * df[,bars]\n", "  \n", "  ## Crunch data\n", "  df$wt <- df[,bars]\n", "  df$value <- df[,line]\n", "  df.crunch <- as.data.frame(data.table(df)[,.(value=sum(value),\n", "                                               wt=sum(wt))\n", "                                            ,by = c(factor1,factor2)])\n", "  \n", "  ## Crunch weight 1-way\n", "  df.crunch.1way <- as.data.frame(data.table(df)[,.(wt=sum(wt))\n", "                                                 ,by = c(factor1)])\n", "  \n", "  ## Convert value to average\n", "  df.crunch$value <- df.crunch$value/df.crunch$wt\n", "  \n", "  ## Rescale\n", "  if (rescale){\n", "    df.crunch$lp <- ifelse(df.crunch$value%in%c(0,1),0,log(df.crunch$value/(1-df.crunch$value)))\n", "    lm.noint <- lm(as.formula(paste(\"lp~\",factor1,\"+\",factor2)),data = df.crunch,weights = df.crunch$wt)\n", "    df.crunch$lp_noint <- predict(lm.noint,newdata = df.crunch)\n", "    df.crunch$lp_int <- df.crunch$lp - df.crunch$lp_noint\n", "    df.crunch$value <- exp(df.crunch$lp_int)/(1+exp(df.crunch$lp_int))\n", "  }\n", "  \n", "  ## Average response\n", "  line.avg <- sum(df.crunch$value*df.crunch$wt)/sum(df.crunch$wt)\n", "  \n", "  ## Rescale weight so that max == line.avg\n", "  df.crunch$wt_rescaled <- df.crunch$wt * line.avg / max(df.crunch.1way$wt)\n", "  \n", "  df.crunch <- df.crunch[order(df.crunch[,factor1],df.crunch[,factor2]),]\n", "    \n", "    chart.title <- paste(factor1,\"by\",factor2)\n", "    if (rescale){\n", "        chart.title <- paste(chart.title,\"(rescaled)\")\n", "    }\n", "    \n", "  ## Plot a chart\n", "  plot.two_way<-ggplot(df.crunch)+\n", "    geom_bar(stat=\"identity\", aes_string(x=factor1,y=\"wt_rescaled\",fill=factor2,group=factor2),col=\"white\",alpha=0.3)+\n", "    geom_line(aes_string(x=factor1,y=\"value\",colour=factor2,group=factor2))+\n", "    geom_point(aes_string(x=factor1,y=\"value\",colour=factor2,group=factor2))+\n", "    theme(axis.text.x = element_text(angle = 60, hjust = 1))+\n", "    labs(y = \"value\" ) + ggtitle(chart.title)\n", "  \n", "  return(plot.two_way)\n", "}"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "03c66f897568371853093527a4a501ba2ad36738", "_cell_guid": "c12a95a1-5a4a-4238-8899-e6955d88804d"}, "source": ["Using some simple plotting functions we inspect one-way trends in the target variable by factor. In each plot, the bars show the proportion of records in each level of the factor and the lines show the average target.\n", "\n", "**Conclusions drawn below:**\n", "* ps_ind_06_bin + ps_ind_07_bin +  ps_ind_08_bin +  ps_ind_09_bin = 1 - ie they are a one-hot encoding of a categorical variable\n", "* ps_ind_14 = ps_ind_10_bin + ps_ind_11_bin + ps_ind_12_bin + ps_ind_13_bin\n", "* ps_ind_03 is likely to appear in a lot of meaningful interactions\n", "* ps_car_13 looks very strong\n", "* If one of ps_ind_16_bin, ps_ind_17_bin and  ps_ind_18_bin is 1, then the others are 0, but they can all be 0"]}, {"cell_type": "markdown", "metadata": {}, "source": ["**ps_ind_03**"]}, {"cell_type": "code", "metadata": {"_uuid": "ed2a5d095ff8a7b9184fd48d4ed45abab6dd3e15", "scrolled": true, "_cell_guid": "52000f14-2cf6-4894-8ea8-c2dc55704cd6"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_03\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "bb9558f1d3f0f75fddf9cec7987a6fa3275a0f18", "_cell_guid": "1c7b84ac-f197-4cd1-85e0-76ecc9f63632"}, "source": ["I imagine this will be a familiar shape to those who've worked with motor insurance claims data before... My guess is that this is a banded version of the policyholder's age."]}, {"cell_type": "code", "metadata": {"_uuid": "7721ba258ba7d32549508dd10b5cc65df4434529", "_cell_guid": "385a75bc-ee75-47af-a52a-0981f6936d48"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_02_cat\")\n", "df$ps_ind_02_cat.001 <- 1*(df$ps_ind_02_cat==1)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_03\",factor2=\"ps_ind_02_cat.001\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_03\",factor2=\"ps_ind_02_cat.001\",rescale=T)\n", "df$ps_ind_0203 <- ifelse(df$ps_ind_02_cat==1,23-df$ps_ind_03,df$ps_ind_03)\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_0203\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "e432f96e5f34c473833102ed572c550607492d23", "_cell_guid": "1f447ca8-8e37-44d9-a03c-6a338ff8daab"}, "source": []}, {"cell_type": "markdown", "metadata": {"_uuid": "a3901a7c8fe9564d5c662982c87c0488ffeb4bca", "_cell_guid": "ea26f268-884a-405f-9fbe-e69cab3189e3"}, "source": ["**ps_ind_06 - 09_bin**\n", "\n", "These variables seem to be a one-hot encoding of some categorical variable - exactly one of them will be equal to one:"]}, {"cell_type": "code", "metadata": {"_uuid": "e614ce38e693cb39c4c87df811a0f8b2dc441330", "_cell_guid": "543a1218-3063-4259-ad96-1907a7506528"}, "source": ["df$ps_ind_06070809 <- paste(df$ps_ind_06_bin,df$ps_ind_07_bin,df$ps_ind_08_bin,df$ps_ind_09_bin,sep=\"\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_06070809\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "0683030ca990a406a4a6574ff5c7a5d7ced36ac7", "_cell_guid": "a227634d-a778-438e-88e8-c4b03967367c"}, "source": ["Seems like an important variable. Let's look for interactions:\n", "\n", "**ps_ind_03 x ps_ind_06 - 09_bin**\n", "\n", "Checking for an interaction with ps_ind_03:"]}, {"cell_type": "code", "metadata": {"_uuid": "0dd0d9f8632a6272ec1b3b133a972d6d476e4760", "_cell_guid": "ff3faaea-0ef6-4a46-b7a5-0412fd443724"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_03\",factor2=\"ps_ind_06070809\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "ebc9a6fe4a1f16fa51b0a9c5915273048986593c", "_cell_guid": "e4e7aeed-4484-4a19-b829-b21c0b1ebd77", "_kg_hide-input": false}, "source": ["Looks like there might be (ie the trends for \"1000\" and \"0001\" ares a lot flatter than for the other two. Rescaling (by converting to logit linear predictors, trying to predict with a no-interaction linear model, and looking at the errors) shows this more clearly:"]}, {"cell_type": "code", "metadata": {"_uuid": "0a99f701c485157f1392fbaa0e1b2119af94f35b", "_cell_guid": "591f0c9b-a2f5-4796-b31f-6d942bb93fea"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_03\",factor2=\"ps_ind_06070809\",rescale=T)"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "53489b66cd12a42d1edeab828d515ea53b4dd3ae", "_cell_guid": "2e91e69b-ada9-4e81-bb7e-bf115b976248"}, "source": ["Once we have removed the main one-way effects from the plot, there are evident \"interaction\" effects left over."]}, {"cell_type": "code", "metadata": {"_uuid": "bfbfe06f5117797f16fecefb00cbf419824c6036", "_cell_guid": "9b0b440d-90e3-400b-976b-02640e469e1a"}, "source": ["df$ps_ind_0708 <- df$ps_ind_07_bin + df$ps_ind_08_bin\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_03\",factor2=\"ps_ind_0708\")\n", "df$ps_ind_030708 <- ifelse(df$ps_ind_0708==1,df$ps_ind_03,-1)\n", "df$ps_ind_030609 <- ifelse(df$ps_ind_0708==0,df$ps_ind_03,-1)\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_030708\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_030609\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "fe043fcf1f17475629dfc92cb56efa917336cedd", "_cell_guid": "ed471c7c-b513-4fdb-983d-91ea4715e334"}, "source": ["**ps_ind_01**"]}, {"cell_type": "code", "metadata": {"_uuid": "efd31490c69b5c625d39d8e0f37c9182fc591581", "_cell_guid": "6c092681-ffda-463a-aea9-465523c8d3e1"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_01\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "2a01faaf9f7e914f60dba2f04a9a95882bc08c7d", "_cell_guid": "7bbf5df4-905d-4257-a103-fdf2fd578121"}, "source": ["**ps_ind_03 x ps_ind_01**"]}, {"cell_type": "code", "metadata": {"_uuid": "1297448a6effe74bd5bcb03db0801b997054100d", "_cell_guid": "3ffca3c9-8dc1-4127-a747-1f9cda127ea5"}, "source": ["df$ps_ind_01_grp <- cut(df$ps_ind_01,breaks = c(-Inf,2,4,7))\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_03\",factor2=\"ps_ind_01_grp\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "3be16e81c205bbccb95b809313b688aa0553a4c1", "_cell_guid": "8560dfc0-de31-45fc-bc60-4e9a0f7cd335"}, "source": ["There is some correlation here. - lower values of ps_ind_03 correlate with lower values of ps_ind_01. This is interesting as they have the opposite one-way effect on the target variable (ie low ps_ind_01 is high risk but lower ps_ind_03 is low risk). A potential juicy interaction to tuck into?"]}, {"cell_type": "code", "metadata": {"_uuid": "1501e23f45d4d686f7de2946faa073339d79e4ee", "_cell_guid": "e3401636-8f46-41ec-bb5f-90836a4d17ee"}, "source": ["df$ps_ind_05_cat.000 <- 1*(df$ps_ind_05_cat==0)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_0708\",factor2=\"ps_ind_05_cat.000\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_0708\",factor2=\"ps_ind_05_cat.000\",rescale=T)\n", "df$ps_ind_050708 <- df$ps_ind_0708 +2*(1-df$ps_ind_05_cat.000)\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_050708\")"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_05_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_17_bin\",factor2=\"ps_ind_05_cat.000\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_17_bin\",factor2=\"ps_ind_05_cat.000\",rescale=T)"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {}, "source": [], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "f3d8bb2d4ee033608156f61a26c656a66bca0018", "_cell_guid": "21c78ec9-df5e-4509-ba03-71af50ec6001"}, "source": ["df$ps_ind_04_cat.001 <- 1*(df$ps_ind_04_cat==1)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_04_cat.001\",factor2=\"ps_ind_0708\")\n", "df$ps_ind_040708 <- df$ps_ind_04_cat.001 + 3*df$ps_ind_0708 -2*(df$ps_ind_04_cat.001*df$ps_ind_0708)\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_040708\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "6e5e51a6c7e8b902576af8e4759d25e0f68ef8f3", "_cell_guid": "9fc43687-91c8-4f69-bfc3-b6900e5c1ad0"}, "source": ["**ps_ind_10 -13_bin**"]}, {"cell_type": "code", "metadata": {"_uuid": "da06eb6f24bede67bd585173efd7fd9776088a86", "_cell_guid": "f1f6d363-77ae-410b-a600-0ae149fd626a"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_10_bin\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_11_bin\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_12_bin\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_13_bin\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "f3c7464fda62492c79134c5dcb278e8475ebdebf", "_cell_guid": "6543d8c0-7201-4576-98fc-5ca4e95aa454"}, "source": ["These seem predictive, similar, but sparsely populated. What if we try combining them up?"]}, {"cell_type": "code", "metadata": {"_uuid": "a884e126180d6a46203df26522bb19ac853b1d09", "_cell_guid": "9d5cbf41-f0bf-43ed-86d5-b43201aa080a"}, "source": ["df$ps_ind_10111213 <- rowSums(df[,c(\"ps_ind_10_bin\",\"ps_ind_11_bin\",\"ps_ind_12_bin\",\"ps_ind_13_bin\")])\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_10111213\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "2f30146877b7f3a11f89828fc01f9616e31698f2", "_cell_guid": "80016e29-6c52-4e8c-bdeb-8decde280de9"}, "source": ["Looks like it might be a good variable. Moving on...\n", "\n", "**ps_ind_14**"]}, {"cell_type": "code", "metadata": {"_uuid": "8d5fdde5f98b543c16b6eeb7660f13068e2212b9", "_cell_guid": "11817706-80a9-4b66-8eb1-9af867b76305"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_14\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "a45446d3f31542d3ae0ad8c78b9cf3a215aa3ed2", "_cell_guid": "0c541769-bf40-4da0-bb11-6d520c95fe95"}, "source": ["Well... that looks familiar."]}, {"cell_type": "code", "metadata": {"_uuid": "6a9eb79e1813ff0671b255275aac7d659e3dbc35", "_cell_guid": "cff95d88-3c2c-46fd-914d-ccb2d0c324af"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_14\",factor2=\"ps_ind_10111213\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "61566119c80da144f6c16c145295e16ed9db3f80", "_cell_guid": "7dcacb16-6116-48ff-8ae6-835c3465b4d0"}, "source": ["You can't quite see it here, but ps_ind_14 is indeed just the sum of 10-13_bin. All that hard work for nothing... I think I have a reasonable guess as to what these factors might relate to.\n", "\n", "**ps_ind_16-18_bin**"]}, {"cell_type": "code", "metadata": {"_uuid": "c63b054cecce72ec66eea820547abc753fa64161", "_cell_guid": "7b11db28-fb45-40f0-9a36-9e9ab51cebd7"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_16_bin\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_17_bin\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_18_bin\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "3a509d84d55e602369ef0c5ab55fa70b2e246313", "_cell_guid": "f119dc5d-3127-4846-820b-ffab9e31fc6f"}, "source": ["Let's see how these binary factors interact:"]}, {"cell_type": "code", "metadata": {"_uuid": "82cdc0e3d7e39f1eee382d3c90004f49afbdecb6", "_cell_guid": "b4105305-94d1-4c0c-87f5-cec5fa05ebf1"}, "source": ["df$ps_ind_161718 <- paste(df$ps_ind_16_bin,df$ps_ind_17_bin,df$ps_ind_18_bin,sep=\"\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_161718\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "f1a5333cc015954e3101875aeb0563be1aad47db", "_cell_guid": "990df409-054a-4b8a-b7df-bb36f0993a28"}, "source": ["So ps_ind_16-18_bin are never 1 together, but they can all be 0. A one-hot encoded variable with missing values that haven't been given?\n", "\n", "**ps_ind_15**"]}, {"cell_type": "code", "metadata": {"_uuid": "402180d18852e5344de7756e755df61624caedea", "_cell_guid": "e0d4645d-0891-47b3-9061-95d458072101"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_ind_15\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "46f1fd0c784b222056a89229f31306b5174e7c6c", "_cell_guid": "9fff2390-cf98-4b7f-b6fa-71be1952324f"}, "source": ["**ps_ind_03 x ps_ind_161718**"]}, {"cell_type": "code", "metadata": {"_uuid": "11f42a78df79a6ba342fa59f124a30897fa57dc6", "_cell_guid": "8c374708-7431-4e78-ba9c-cc47b1be3962"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_161718\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "1db2a442f0b0bd736728485b9ff1a185bd730542", "_cell_guid": "8d5d0d9c-e3c5-4ad0-a0a5-dddd15a7bfaa"}, "source": ["There appear  to be some correlations here. In particular, most of the \"000\" cases are getting mapped to ps_ind_15 = 10.\n", "\n", "**ps_ind_15 x ps_ind_06070898**"]}, {"cell_type": "code", "metadata": {"_uuid": "d5ed5c1abf0967db8d0b045c959de9fc7dd4ffec", "_cell_guid": "5d2b7be7-7dd6-47fe-9160-feb51ac1e411"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_06070809\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "321dfdc7abbc73ceec1847bbc7b538fe1ac9f9b4", "_cell_guid": "b7b2a2ff-cbd5-4f35-80cf-947bea078d3b"}, "source": ["There variables are less correlated."]}, {"cell_type": "code", "metadata": {"_uuid": "b828a3c2f76cb2f991bb9f5aebc433d21f296089", "_cell_guid": "3faec373-e210-465c-9c13-cd90f44f3c99"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_01\")\n", "plot_two_way(df=df[df$ps_ind_02_cat!=-1,],line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_02_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_03\")\n", "plot_two_way(df=df[df$ps_ind_04_cat!=-1,],line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_04_cat\")\n", "plot_two_way(df=df[df$ps_ind_04_cat!=-1,],line=\"target\",factor1=\"ps_ind_15\",factor2=\"ps_ind_04_cat\",rescale=T)"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "df0644cb3bbacee44210deff4b14c04478aba41c", "_cell_guid": "c387017b-12b1-405a-bc64-0f5aa76a3647"}, "source": ["**ps_car_13**"]}, {"cell_type": "code", "metadata": {"_uuid": "e5c2eeef355931ee58bd8c85d96026da3de442b0", "_cell_guid": "84cb991b-f220-4a7a-a66c-fbb520c87331"}, "source": ["df$ps_car_13_grp <- cut(df$ps_car_13,c(-Inf,quantile(df$ps_car_13,probs=1:19/20),Inf))\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_car_13_grp\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "e8c0730a1882ab7989bf0d1e25cfb5d69309d0e0", "_cell_guid": "f7b5548a-a900-49a8-a7b0-354466b2da7c"}, "source": ["This seems to be one of the strongest single variables coming through in models so far. It also seems to be a continuous variable, so we need to band it before plotting."]}, {"cell_type": "code", "metadata": {"_uuid": "d545cf9278b666120728ddd9b2d6a32e843a27cb", "_cell_guid": "8b15b717-0643-49d6-a9eb-5cec2e909b89"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_ind_06070809\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_ind_06070809\",rescale=T)"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "f18949440d4b9ae3999292b9cae24cf576d310d7", "_cell_guid": "dd5fc802-9e93-412f-8236-9e9c7f02922f"}, "source": ["plot_two_way(df=df[df$ps_car_02_cat!=-1,],line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_02_cat\")\n", "plot_two_way(df=df[df$ps_car_02_cat!=-1,],line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_02_cat\",rescale=T)\n", "\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_03_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_03_cat\",rescale=T)\n", "\n", "df$ps_car_04_cat_t <- pmin(df$ps_car_04_cat,2)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_04_cat_t\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_04_cat_t\",rescale=T)\n", "\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_05_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_05_cat\",rescale=T)\n", "\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_07_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_07_cat\",rescale=T)\n", "\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_08_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_08_cat\",rescale=T)\n", "\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_09_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_09_cat\",rescale=T)\n", "\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_03_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_03_cat\",rescale=T)\n", "\n", "df$ps_car_11_cat_104 <- 1 * (df$ps_car_11_cat==104)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_11_cat_104\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_13_grp\",factor2=\"ps_car_11_cat_104\",rescale=T)"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "b6224d40383d2d4d48f1a48ca7551e9b31679531", "_cell_guid": "b886184f-2ffb-4f20-a54d-c064a7e66050"}, "source": ["df$ps_car_15_t <- round(df$ps_car_15^2,4)\n", "df$ps_car_15_t.lt14 <- 1*(df$ps_car_15_t<14)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_15_t\",factor2=\"ps_car_03_cat\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_15_t\",factor2=\"ps_car_03_cat\",rescale=T)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_03_cat\",factor2=\"ps_car_15_t.lt14\")\n", "\n", "df$ps_car_0315 <- df$ps_car_03_cat * (1+df$ps_car_15_t.lt14)\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_car_0315\")\n"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "ef79ca153649dc1c2d9837526e223e9cb910dc51", "_cell_guid": "f43dc244-78a0-4572-a796-cb0039c44f4d"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_car_03_cat\",factor2=\"ps_ind_17_bin\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_car_03_cat\",factor2=\"ps_ind_17_bin\",rescale=T)\n", "df$ps_car_03_ind_17 <- (df$ps_car_03_cat==-1) * df$ps_ind_17_bin"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "e530cf3cc0558b379be8cefb5235361da0e813cb", "_cell_guid": "c6a38d19-2911-4dbe-9e9c-6c64ecc9b412"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_reg_01\")"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "a9b33fd0bffff3980b27aee0883feffdfcf2cdc3", "_cell_guid": "b6c1e484-5ca6-4b52-ae63-2611f37a2481"}, "source": ["plot_one_way(df=df,lines=\"target\",factor=\"ps_reg_02\")"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "1f6be58992906de2536deccdc8879a36b43acabf", "_cell_guid": "cf360ae0-9d66-4f83-a92b-6f7535c1a51f"}, "source": ["plot_two_way(df=df,line=\"target\",factor1=\"ps_reg_02\",factor2=\"ps_ind_05_cat.000\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_reg_02\",factor2=\"ps_ind_05_cat.000\",rescale=T)\n", "df$ps_reg_02_ind_05 <- ifelse(df$ps_ind_05_cat.000==1,-1,df$ps_reg_02)\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_reg_02_ind_05\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "13348f486e0a5e8d536cf302ebbe152640d98233", "_cell_guid": "e8d25fe3-eb31-4d0d-a413-355ab5608e39"}, "source": ["**ps_reg_03**\n", "\n", "As an aside, reg_03 seems to be a transformation of a 2dp number. Possibly a monetary amount?\n", "\n", "UPDATE: As noted elsewhere, it's might be better to multiply by another 100 to get an integer..."]}, {"cell_type": "code", "metadata": {"_uuid": "d63d41a63a3032a96d0647a770b4c4644fa349c5", "_cell_guid": "1301518b-cb54-4c95-9ebe-2f87c232ae73"}, "source": ["df$ps_reg_03_t <- ifelse(df$ps_reg_03==-1,-1,round(16*df$ps_reg_03^2,5))"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "270851de5ec8a98ee7ba206964a202246da6d55d", "_cell_guid": "916daa4b-c7dc-4ac3-88f2-a4f9081e58dc"}, "source": ["df$ps_reg_03_t_grp <- cut(df$ps_reg_03_t,breaks = c(-Inf,-1,quantile(df$ps_reg_03_t[df$ps_reg_03_t!=-1],probs = 1:20/20)))\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_reg_03_t_grp\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "9208f1f373b57c709596ea13633840ed4cdeb643", "_cell_guid": "bd81a2bb-822e-41ea-876e-317bf99181ed"}, "source": ["Investigating a couple of interactions inspired by factors created in https://www.kaggle.com/ogrellier/xgb-classifier-upsampling-lb-0-283/code:"]}, {"cell_type": "code", "metadata": {"_uuid": "d68a2761b5de9a6a5eaaede41dc98ada1c5fd428", "_cell_guid": "f1319894-f541-4fa2-8eb6-a80ef1ad389e"}, "source": ["df$ps_reg_01_t <- ifelse(df$ps_reg_01==0,1,df$ps_reg_01)\n", "df$ps_car_02_cat_t <- 1-pmax(df$ps_car_02_cat,0)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_reg_01_t\",factor2=\"ps_car_02_cat_t\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_reg_01_t\",factor2=\"ps_car_02_cat_t\",rescale=T)\n", "df$ps_reg_01_car_02_cat <- paste(df$ps_car_02_cat_t,df$ps_reg_01_t,sep=\"_\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_reg_01_car_02_cat\")"], "execution_count": null, "outputs": []}, {"cell_type": "code", "metadata": {"_uuid": "68718109829049912a1332a7311091360fe9e347", "_cell_guid": "cf5471f5-4add-4e01-b584-702c935c82d6"}, "source": ["df$ps_car_04_cat_t <- pmin(df$ps_car_04_cat,1)\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_reg_01_t\",factor2=\"ps_car_04_cat_t\")\n", "plot_two_way(df=df,line=\"target\",factor1=\"ps_reg_01_t\",factor2=\"ps_car_04_cat_t\",rescale=T)\n", "df$ps_reg_01_car_04_cat <- paste(df$ps_car_04_cat_t,df$ps_reg_01_t,sep=\"_\")\n", "plot_one_way(df=df,lines=\"target\",factor=\"ps_reg_01_car_04_cat\")"], "execution_count": null, "outputs": []}, {"cell_type": "markdown", "metadata": {"_uuid": "0e7abcb1e7a50befce83e3b0ab051e0cd25320bf", "_cell_guid": "c2fc6591-f542-4c94-aa0d-1e8981ac2f90"}, "source": ["**Batch runs (for completeness)**"]}, {"cell_type": "code", "metadata": {"_uuid": "af5b06f91b7154738c8e41dce99781e7ec1ebc3a", "_cell_guid": "55d6bc37-7064-411c-9792-38de5507c46e"}, "source": ["plot.vars <- colnames(df)[which(colnames(df)==\"ps_ind_01\"):which(colnames(df)==\"ps_calc_20_bin\")]\n", "df.plot <- df[,c(\"target\",plot.vars)]\n", "for (var in plot.vars){\n", "    if (length(unique(df.plot[,var]))>50){\n", "        df.plot[,var] <- cut(df.plot[,var],c(-Inf,unique(quantile(df.plot[,var],probs=1:49/50)),Inf))\n", "    }\n", "    print(plot_one_way(df=df.plot,lines=\"target\",factor=var))\n", "}"], "execution_count": null, "outputs": []}], "nbformat_minor": 1, "nbformat": 4}